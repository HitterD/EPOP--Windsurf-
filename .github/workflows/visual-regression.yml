name: Visual Regression Tests

on:
  pull_request:
    paths:
      - 'components/**'
      - 'app/**'
      - 'stories/**'
      - 'tailwind.config.ts'
      - 'app/globals.css'
      - 'tests/visual/**'
      - '.github/workflows/visual-regression.yml'

jobs:
  visual-regression:
    name: Visual Regression Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Build Storybook
        run: npm run build-storybook

      - name: Run visual regression tests
        run: npx playwright test --config=playwright.visual.config.ts
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-report
          path: |
            playwright-report/visual/
            tests/visual/snapshots/
          retention-days: 30

      - name: Upload failed screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-failures
          path: |
            tests/visual/snapshots/**/*-actual.png
            tests/visual/snapshots/**/*-diff.png
          retention-days: 30

      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const resultsPath = 'playwright-report/visual-results.json'
            
            if (!fs.existsSync(resultsPath)) {
              return
            }
            
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'))
            const { suites } = results
            
            let totalTests = 0
            let passed = 0
            let failed = 0
            
            function countTests(suite) {
              for (const spec of suite.specs || []) {
                totalTests++
                const testStatus = spec.tests[0]?.results[0]?.status
                if (testStatus === 'passed') passed++
                if (testStatus === 'failed') failed++
              }
              for (const child of suite.suites || []) {
                countTests(child)
              }
            }
            
            countTests(suites[0])
            
            const status = failed === 0 ? '‚úÖ Passed' : '‚ùå Failed'
            const emoji = failed === 0 ? 'üé®' : '‚ö†Ô∏è'
            
            const comment = `
            ## ${emoji} Visual Regression Test Results
            
            **Status:** ${status}
            
            | Metric | Count |
            |--------|-------|
            | Total Tests | ${totalTests} |
            | ‚úÖ Passed | ${passed} |
            | ‚ùå Failed | ${failed} |
            
            ${failed > 0 ? `
            ### Failed Tests
            
            Visual differences were detected. Please review the test report artifacts.
            
            **To update snapshots locally:**
            \`\`\`bash
            npm run test:visual:update
            \`\`\`
            ` : ''}
            
            [üìä View full report](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}})
            `
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })

      - name: Fail if tests failed
        if: failure()
        run: |
          echo "‚ùå Visual regression tests failed"
          echo "Review the uploaded artifacts for visual diffs"
          exit 1

  # Optional: Auto-update snapshots if PR is labeled
  update-snapshots:
    name: Update Visual Snapshots
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'update-snapshots')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Update snapshots
        run: npx playwright test --config=playwright.visual.config.ts --update-snapshots
        env:
          UPDATE_SNAPSHOTS: true

      - name: Commit updated snapshots
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/visual/snapshots/
          git diff --staged --quiet || git commit -m "chore: update visual regression snapshots"
          git push

      - name: Remove label
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'update-snapshots'
            })
